version: '3.8'

services:
  orchestrator:
    build:
      context: ../..
      dockerfile: apps/orchestrator_3_stream/Dockerfile
    container_name: orchestrator_3_stream
    restart: unless-stopped
    ports:
      - "9403:9403"
    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL}

      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_PAT=${GITHUB_PAT}

      # Backend Config
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=9403
      - ORCHESTRATOR_MODEL=${ORCHESTRATOR_MODEL:-claude-sonnet-4-20250514}
      - ORCHESTRATOR_WORKING_DIR=/app
      - DEFAULT_WORKING_DIR=/app

      # Frontend Config (served by FastAPI on same port)
      - VITE_API_BASE_URL=https://dev.ozean-licht.dev
      - VITE_WS_URL=wss://dev.ozean-licht.dev/ws

      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS:-https://dev.ozean-licht.dev,https://admin.ozean-licht.dev}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=/app/backend/logs

    volumes:
      - orchestrator-data:/app/data
      - orchestrator-logs:/app/backend/logs
      # Mount git repo for ADW (if on same server)
      - /opt/ozean-licht-ecosystem:/opt/ozean-licht-ecosystem:ro

    networks:
      - orchestrator-network
      - coolify

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9403/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  orchestrator-network:
    driver: bridge
  coolify:
    external: true
    name: coolify

volumes:
  orchestrator-data:
  orchestrator-logs:
