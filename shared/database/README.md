# Shared Users Database (`shared_users_db`)

Unified authentication database for the Ozean Licht Ecosystem. Provides single sign-on, multi-tenant access control, and session management.

## Quick Start

```bash
# 1. Configure environment
cp example.env .env
# Set SHARED_USERS_DB_URL in .env

# 2. Run migration
./scripts/run-migration.sh

# 3. Verify setup
npx ts-node scripts/test-connection.ts

# 4. Generate Prisma client
npm install && npx prisma generate
```

## Purpose

- **Unified Authentication**: Single user accounts across all platforms
- **Multi-Tenant Access Control**: Platform-specific roles via `user_entities` table
- **Session Management**: JWT session storage for NextAuth.js
- **OAuth Ready**: Future-ready OAuth integration (Google, GitHub, etc.)

## Environment Variables

```env
# Connection string (required)
SHARED_USERS_DB_URL=postgresql://postgres:password@localhost:5430/shared_users_db

# Individual settings (alternative)
POSTGRES_HOST_SHARED=localhost
POSTGRES_PORT_SHARED=5430
POSTGRES_USER_SHARED=postgres
POSTGRES_PASSWORD_SHARED=your_password
POSTGRES_DB_SHARED=shared_users_db
```

## Schema Overview

| Table | Purpose |
|-------|---------|
| `users` | Core user accounts (email, password, profile) |
| `user_entities` | Platform access mapping with roles |
| `sessions` | JWT session storage |
| `oauth_accounts` | OAuth provider accounts |
| `password_reset_tokens` | Password reset flow |
| `email_verification_tokens` | Email verification flow |

### User Roles

```typescript
enum UserRole {
  USER        // Regular user
  CREATOR     // Content creator
  EDUCATOR    // Teacher/educator
  ADMIN       // Platform administrator
  MODERATOR   // Content moderator
  SUPPORT     // Support staff
}
```

## Usage

### Prisma Client

```typescript
import { PrismaClient } from ".prisma/client-shared-users"

const prisma = new PrismaClient({
  datasources: {
    db: { url: process.env.SHARED_USERS_DB_URL }
  }
})

// Query users with platform access
const users = await prisma.user.findMany({
  where: { isActive: true },
  include: { userEntities: true }
})
```

### MCP Gateway Integration

```typescript
import { MCPGatewayClientWithQueries } from '../mcp-client'

const mcpClient = new MCPGatewayClientWithQueries({
  baseUrl: process.env.MCP_GATEWAY_URL || 'http://localhost:8100',
  database: 'shared-users-db'
})

const users = await mcpClient.query(
  'SELECT * FROM users WHERE email = $1',
  [email]
)
```

## Scripts

| Script | Command | Description |
|--------|---------|-------------|
| Run migration | `./scripts/run-migration.sh` | Creates database and tables |
| Test connection | `npm run test:connection` | Validates setup |
| Generate Prisma | `npm run prisma:generate` | Generates type-safe client |
| Prisma Studio | `npm run prisma:studio` | Visual database browser |

## Related Files

- Admin migrations: `apps/admin/migrations/001_create_admin_schema.sql`
- Admin auth config: `apps/admin/lib/auth/config.ts`

---

<!-- CONTEXT-MAP:START - Auto-generated by context-mapper. Do not edit below this line. -->

## Context Map

> Updated: 2025-11-25 | Files: 7 | Entropy: 15/100

### Start Here

| File | Purpose |
|------|---------|
| `prisma/schema.prisma` | Database models (User, Session, OAuth) |
| `migrations/000_create_shared_users_db.sql` | Initial schema migration |
| `scripts/run-migration.sh` | One-command database setup |

### Structure

```
shared/database/
├── README.md                 # This file
├── package.json              # Package config (@shared/database)
├── tsconfig.json             # TypeScript config
├── prisma/
│   └── schema.prisma         # Prisma schema (6 models, 2 enums)
├── migrations/
│   └── 000_create_shared_users_db.sql  # Initial migration
├── scripts/
│   ├── run-migration.sh      # Migration runner (bash)
│   └── test-connection.ts    # Connection validator (ts-node)
└── node_modules/             # Dependencies (gitignored)
```

### Inventory

| Category | Files | Notes |
|----------|-------|-------|
| Schema | 2 | Prisma + SQL migration |
| Scripts | 2 | Migration + test |
| Config | 3 | package.json, tsconfig, README |

### Temperature

**Hot:** `prisma/schema.prisma`, `scripts/run-migration.sh`
**Warm:** `scripts/test-connection.ts`, `package.json`
**Cold:** `tsconfig.json`

### Database Tables

| Table | Columns | Indexes | Purpose |
|-------|---------|---------|---------|
| `users` | 17 | 4 | Core accounts |
| `user_entities` | 9 | 5 | Platform mapping |
| `sessions` | 8 | 4 | JWT storage |
| `oauth_accounts` | 13 | 3 | OAuth providers |
| `password_reset_tokens` | 7 | 3 | Password reset |
| `email_verification_tokens` | 8 | 3 | Email verification |

### Dependencies

```json
{
  "@prisma/client": "^5.8.0",
  "pg": "^8.11.3",
  "prisma": "^5.8.0",
  "ts-node": "^10.9.2"
}
```

### Entropy: 15/100

- Files: 7 (excluding node_modules)
- Well organized, minimal structure
- No orphan files detected
- Next review: 2025-12-09

<!-- CONTEXT-MAP:END -->
